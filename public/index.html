<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Cavalry Web Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        overflow: hidden;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Square viewport */
      #viewport {
        position: relative;
        background: transparent;
      }

      /* Canvas centered inside viewport */
      canvas {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: block;
      }
    </style>
  </head>

  <body>
    <div id="viewport">
      <canvas id="canvas"></canvas>
    </div>

    <script type="module">
      const log = (...args) => console.log("[CWP]", ...args)

      const canvas = document.getElementById("canvas")
      const viewport = document.getElementById("viewport")

      // ðŸ“ Live scene resolution (driven externally)
      let SCENE_WIDTH = 1080
      let SCENE_HEIGHT = 1920

      let Module
      let app
      let surface

      function resizeViewportAndSurface() {
        if (!Module) return

        const winW = window.innerWidth
        const winH = window.innerHeight

        // Square viewport based on smallest window dimension
        const viewportSize = Math.min(winW, winH)
        viewport.style.width = viewportSize + "px"
        viewport.style.height = viewportSize + "px"

        const compAspect = SCENE_WIDTH / SCENE_HEIGHT

        let renderW, renderH

        // Fit comp inside square (contain)
        if (compAspect >= 1) {
          // Landscape or square
          renderW = viewportSize
          renderH = Math.round(viewportSize / compAspect)
        } else {
          // Portrait
          renderH = viewportSize
          renderW = Math.round(viewportSize * compAspect)
        }

        canvas.width = renderW
        canvas.height = renderH

        surface = Module.makeWebGLSurfaceFromElement(
          canvas,
          renderW,
          renderH
        )
      }

      try {
        /* 1) Import the Web Player module */
        log("Importing CavalryWasm.js")
        const CavalryModule = await import("/CavalryWasm.js")

        /* 2) Initialise WASM */
        log("Initialising module")
        Module = await CavalryModule.default({
          canvas,
          locateFile: (path) => `/wasm-lib/${path}`,
        })

        /* 3) Load scene into WASM filesystem */
        log("Loading scene.cv")
        const res = await fetch("/scenes/scene.cv")
        if (!res.ok) throw new Error("Failed to load scene.cv")

        const sceneBytes = new Uint8Array(await res.arrayBuffer())
        Module.FS.writeFile("scene.cv", sceneBytes)

        /* 4) Create Cavalry app */
        log("Creating app")
        app = Module.Cavalry.MakeWithPath("scene.cv")

        /* 5) Listen for external control messages */
        window.addEventListener("message", (event) => {
          const data = event.data
          if (!data || typeof data !== "object") return
          if (data.type !== "set-attribute") return

          const { path, value } = data

          try {
            app.setAttribute(
              path.slice(0, path.indexOf(".")),
              path.slice(path.indexOf(".") + 1),
              value
            )

            // ðŸ“ Resolution updates
            if (path === "compNode#1.resolution") {
              const [w, h] = value
              if (w > 0 && h > 0) {
                SCENE_WIDTH = w
                SCENE_HEIGHT = h
                log("Resolution updated:", w, "x", h)
                resizeViewportAndSurface()
              }
            }
          } catch (err) {
            console.error("[CWP] setAttribute failed", err)
          }
        })

        /* 6) Initial surface + resize handling */
        resizeViewportAndSurface()
        window.addEventListener("resize", resizeViewportAndSurface)

        /* 7) Start playback + render loop */
        log("Starting playback")
        app.play()

        function tick(time) {
          if (!app.isPlaying()) return
          app.tick(surface, time)
          requestAnimationFrame(tick)
        }

        requestAnimationFrame(tick)
        log("Running âœ“")

      } catch (err) {
        console.error("[CWP] Fatal error", err)
        document.body.innerHTML = `
          <div style="padding:16px;font-family:system-ui;color:#c00">
            <strong>Cavalry Web Player failed to start.</strong><br/>
            Open DevTools â†’ Console for details.
          </div>
        `
      }
    </script>
  </body>
</html>
